<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gainsight PX Dataloader</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<style>
		table {
			font-family: arial, sans-serif;
			border-collapse: collapse;
			width: 100%;
		}
		td,th {
			border: 1px solid #dddddd;
			text-align: left;
			padding: 8px;
		}
		tr:nth-child(even) {
			background-color: #dddddd;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
		integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
		crossorigin="anonymous"></script>
	<script src="js/papaparse.js"></script>
	<script>
		$(document).ready(function () {
			//show hide account\user related fields
			$("input[name='objectSelection']").click(function () {
				var temp = $(this).val();
				$("div.objectOutput").hide();
				$("#" + temp + "IdInput").show();
			});
			//handling fields when selecting 'bulk' option
			$("input[name='operationSelection']").click(function () {
				var temp = $(this).val();
				$("div.custom-file").hide();
				$("input.objectOutput").prop('disabled', false);
				if (temp === "Bulk_Update" || temp=== "Bulk_Delete") {
					$("input.objectOutput").prop('disabled', true);
					$("div.custom-file").show();
				}
			});
			//override the default form submit with the handler function
			$('#mainform').submit(function () {
				clickHandler();
				return false;
			});
			//listener to parse csv file
			$('#customFile').on('change', function (event) {
				$("label[for='customFile']").text($('#customFile').val());
				Papa.parse(event.target.files[0], {
					complete: function (results) {
						filePreview(results);
						console.log(results);
					}
				});
			})
		});

		function filePreview(filejson) {
			var tbl_body = document.createElement("tbody");
			var odd_even = false;
			$.each(filejson.data, function () {
				var tbl_row = tbl_body.insertRow();
				tbl_row.className = odd_even ? "odd" : "even";
				$.each(this, function (k, v) {
					var cell = tbl_row.insertCell();
					cell.appendChild(document.createTextNode(v.toString()));
				});
				odd_even = !odd_even;
			});
			$("#responseTable").append(tbl_body);
		}

		function setHeader() {
			$.ajaxSetup({
				headers: {
					"X-Requested-With": "XMLHttpRequest",
					"Content-Type": "application/json",
					"X-APTRINSIC-API-KEY": $('#apikey').val()
				}
			});
		}

		function getUserId() {
			return $("#useridentify").val();
		}

		function handleResponseSuccess(result, status, xhr) {
			var csv = Papa.unparse(JSON.stringify(result).replace('\"', '"'));
			showalert(JSON.stringify(result), "alert-success");
		}
		/*function handleResponseSuccess(result, status, xhr) {
			//printing only first 10 columns
			var tbl_body = document.createElement("tbody");
			var i=0;
			var odd_even = false;
			$.each(result, function () {
				var tbl_row = tbl_body.insertRow();
				tbl_row.className = odd_even ? "odd" : "even";
				$.each(this, function (k, v) {
					var cell = tbl_row.insertCell();
					cell.appendChild(document.createTextNode(v.toString()));
				});
				odd_even = !odd_even;
				i++;
				if(i==10){
					return false;
				}
			});
			$("#responseTable tbody").html(tbl_body);

		}*/

		function handleResponseError(result, status, xhr) {
			showalert(JSON.stringify(result), "alert-danger");
		}


		function getUserData() {
			var userid = getUserId();
			setHeader();

			$.ajax({
				dataType: "json",
				url: "https://app-be.aptrinsic.com/v1/users/" + userid,
				success: function (data, status, xhr) {
					handleResponseSuccess(data, status, xhr);
				},
				error: function (data, status, xhr) {
					handleResponseError(data, status, xhr);
				}
			});
		}


		function deleteUserData() {
			var userid = getUserId();
			var myHeaders = getHeader();
			var raw = "";

			var requestOptions = {
				method: 'DELETE',
				headers: myHeaders,
				body: raw,
				redirect: 'follow'
			};

			fetch("https://app-be.aptrinsic.com/v1/users/" + userid, requestOptions)
				.then(response => response.text())
				.then(result => handleResponseSuccess(result))
				.catch(error => handleResponseError(result));
		}


		function updateUserData() {
			showalert("Work in progress, try fetch or delete", "alert-danger");
		}

		function unHandledOperation() {
			showalert("we haven't implemented that yet", "alert-danger");

		}

		function showalert(message, alerttype) {
			//Types of alerts -- "alert-danger","alert-success","alert-info","alert-warning"
			$('#executionResult').append('<div class="alert-dismissible fade show alert ' + alerttype + '">' + message + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
		}

		function clickHandler() {
			$('#executeButton').attr("disabled", true);
			$('#executeButton').html(`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Loading...`);

			if ($("input[name='objectSelection']:checked").val() === "Account") {
				unHandledOperation();
			}
			else {
				switch ($("input[name='operationSelection']:checked").val()) {
					case "Read":
						getUserData();
						break;
					case "Update":
						unHandledOperation();
						break;
					case "Delete":
						deleteUserData();
						break;
					case "Bulk_Update":
						unHandledOperation();
                        break;
                    case "Bulk_Delete":
						unHandledOperation();
						break;
				}
			}
			$('#executeButton').text("Execute");
			$('#executeButton').attr("disabled", false);
		}


	</script>
</head>

<body id="loader-page" style="padding: 10px;">
	<form id="mainform"
		style="width: 60em; border: solid 2px #545854!important; margin-top: 0px; border-radius: 25px; padding: 15px;">
		<h1>Gainsight PX Data Loader</h1>
		<br>
		<div class="form-group row">
			<label for="apikey" class="col-sm-2 col-form-label">API Key</label>
			<div class="col-sm-10"><input type="password" class="form-control" id="apikey" placeholder="Enter API Key"
					required>
			</div>
		</div>
		<div class="row">
			<div class="col">Update Data For : </div>
			<div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="objectSelection" id="option_account"
						value="Account" checked>
					<label class="form-check-label" for="option_account">Account</label>
				</div>
			</div>
			<div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="objectSelection" id="option_user" value="User">
					<label class="form-check-label" for="option_user">User</label>
				</div>
			</div>
		</div>

		<br />
		<div class="form-group row objectOutput" id="AccountIdInput">
			<label for="accountidentify" class="col-sm-2 col-form-label">Account ID :</label>
			<div class="col-sm-10"><input type="text" class="form-control objectOutput" id="accountidentify"
					placeholder="Enter Account ID"></div>
		</div>
		<div class="form-group row objectOutput" id="UserIdInput" style="display:none;">
			<label for="useridentify" class="col-sm-2 col-form-label">User ID :</label>
			<div class="col-sm-10"><input type="text" class="form-control objectOutput" id="useridentify"
					placeholder="Enter User ID"></div>
		</div>

		<div class="row">
			<div class="col">Select Operation : </div>
			<div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="operationSelection" id="option_read" checked
						value="Read">
					<label class="form-check-label" for="option_read">Read</label>
				</div>
			</div>
			<div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="operationSelection" id="option_update"
						value="Update">
					<label class="form-check-label" for="option_update">Update</label>
				</div>
			</div>
			<div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="operationSelection" id="option_delete"
						value="Delete">
					<label class="form-check-label" for="option_delete">Delete</label>
				</div>
			</div>
			<div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="operationSelection" id="option_bulk_update"
						value="Bulk_Update">
					<label class="form-check-label" for="option_bulk_update">Bulk Update</label>
				</div>
            </div>
            <div class="col">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="operationSelection" id="option_bulk_delete"
						value="Bulk_Delete">
					<label class="form-check-label" for="option_bulk_delete">Bulk Delete</label>
				</div>
			</div>
		</div>
		<br>
		<div class="custom-file" style="display:none;">
			<input type="file" class="custom-file-input" id="customFile" accept=".csv">
			<label class="custom-file-label" for="customFile">Choose file</label>
		</div>
		<br />
		<br />
		<div>
			<button type="submit" class="btn btn-primary" id="executeButton">
				Execute
			</button>
		</div>
	</form>
	<div>
		<br>
		Execution result :
		<div id="executionResult"></div>
		<br>
		File Content :
		<table id="responseTable" style="border: 2px;">
		</table>
	</div>
</body>
</html>